@page "/forecast"
@rendermode InteractiveWebAssembly

@using Newtonsoft.Json
@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor
@using System.Globalization

<h3>Bitcoin 30-Day Forecast (EMA + ATR)</h3>

<style>
    h3 {
        color: #007bff;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .forecast-box {
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .chart-title {
        margin-bottom: 0.3rem !important;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

        table th {
            background: #007bff;
            color: white;
            padding: 10px;
        }

        table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
</style>

@if (_forecast == null)
{
    <p>Loading forecast...</p>
}
else
{
    <div class="forecast-box">
        <p><strong>Current Price:</strong> $@_currentPrice</p>
        <p><strong>EMA Trend:</strong> @_trendDescription</p>
    </div>

    <h3 class="chart-title">Forecast Line Chart</h3>

    <RadzenStack class="rz-p-0 rz-p-md-6 rz-p-lg-2">
        <RadzenCard Variant="Variant.Outlined">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="smooth" />
                    <RadzenLabel Text="Smooth" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="showDataLabels" />
                    <RadzenLabel Text="Show Data Labels" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="showMarkers" />
                    <RadzenLabel Text="Show Markers" />
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="sharedTooltip" />
                    <RadzenLabel Text="Shared Tooltip" />
                </RadzenStack>

            </RadzenStack>
        </RadzenCard>

        <RadzenChart>
            <RadzenChartTooltipOptions Shared="@sharedTooltip" />

            <RadzenLineSeries Data="@chartData"
                              CategoryProperty="Date"
                              ValueProperty="Forecast"
                              Title="Forecast"
                              Smooth="@smooth">
                <RadzenMarkers Visible="@showMarkers" />
                <RadzenSeriesDataLabels Visible="@showDataLabels" />
            </RadzenLineSeries>

            <RadzenLineSeries Data="@chartData"
                              CategoryProperty="Date"
                              ValueProperty="Min"
                              Title="Min (ATR)"
                              LineType="LineType.Dashed" />

            <RadzenLineSeries Data="@chartData"
                              CategoryProperty="Date"
                              ValueProperty="Max"
                              Title="Max (ATR)"
                              LineType="LineType.Dashed" />

            <RadzenCategoryAxis Padding="20" />
            <RadzenValueAxis Formatter="@FormatAsUSD">
                <RadzenGridLines Visible="true" />
                <RadzenAxisTitle Text="USD" />
            </RadzenValueAxis>
        </RadzenChart>
    </RadzenStack>

    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Min Price (ATR)</th>
                <th>Forecast Price (EMA)</th>
                <th>Max Price (ATR)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var day in _forecast)
            {
                <tr>
                    <td>@day.Date.ToShortDateString()</td>
                    <td>$@day.MinPrice.ToString("N2")</td>
                    <td>$@day.ForecastPrice.ToString("N2")</td>
                    <td>$@day.MaxPrice.ToString("N2")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    [Inject] IJSRuntime JS { get; set; }

    private List<ForecastPoint>? _forecast;
    private double _currentPrice;
    private string _trendDescription = "";

    private bool smooth;
    private bool sharedTooltip = true;
    private bool showDataLabels;
    private bool showMarkers = true;

    private List<ChartItem> chartData = new();

    private record MarketChart(List<List<double>> prices);
    private record ForecastPoint(DateTime Date, double ForecastPrice, double MinPrice, double MaxPrice);

    private class ChartItem
    {
        public string Date { get; set; } = "";
        public double Forecast { get; set; }
        public double Min { get; set; }
        public double Max { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadForecast();
    }

    private async Task LoadForecast()
    {
        using var http = new HttpClient();
        var request = new HttpRequestMessage(
        HttpMethod.Get,
        "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=30"
        );

            request.Headers.Add("x-cg-demo-api-key", "CG-wm4ffY58QtHMP9xpWAhCXUxW");
            // var response = await http.GetAsync(url);
            var response = await http.SendAsync(request);
                        var json = await response.Content.ReadAsStringAsync();
        var data = JsonConvert.DeserializeObject<MarketChart>(json)!;

        var prices = data.prices
            .Select(p => p[1])
            .ToList();

        _currentPrice = prices.Last();

        // EMA
        int period = 10;
        double multiplier = 2.0 / (period + 1);
        var ema = prices[0];

        foreach (var price in prices.Skip(1))
            ema = (price - ema) * multiplier + ema;

        _trendDescription = ema >= _currentPrice ? "Uptrend (bullish)" : "Downtrend (bearish)";

        // ATR
        var atr = prices.Zip(prices.Skip(1), (a, b) => Math.Abs(b - a)).Average();

        var rnd = new Random();
        _forecast = new();

        for (int i = 1; i <= 30; i++)
        {
            var factor = 0.5 + rnd.NextDouble();
            var min = ema - atr * factor;
            var max = ema + atr * factor;

            var date = DateTime.Now.AddDays(i);

            _forecast.Add(new ForecastPoint(date, ema, min, max));
            chartData.Add(new ChartItem
            {
                Date = date.ToString("MM/dd"),
                Forecast = ema,
                Min = min,
                Max = max
            });

            ema += (0.2 - rnd.NextDouble() * 0.4) * atr;
        }
    }

    string FormatAsUSD(object value)
        => ((double)value).ToString("C0", CultureInfo.GetCultureInfo("en-US"));
}
